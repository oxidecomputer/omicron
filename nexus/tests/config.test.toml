#
# Oxide API: configuration file for test suite
#

[console]
# Directory for static assets. Absolute path or relative to CWD.
static_dir = "tests/static"
session_idle_timeout_minutes = 480 # 8 hours
session_absolute_timeout_minutes = 1440 # 24 hours

# List of authentication schemes to support.
[authn]
schemes_external = ["spoof", "session_cookie", "access_token", "scim_token"]

#
# NOTE: for the test suite, if mode = "file", the file path MUST be the sentinel
# string "UNUSED".  The actual path will be generated by the test suite for each
# test.
#
[log]
level = "trace"
mode = "file"
if_exists = "fail"
path = "UNUSED"

# Configuration for interacting with the timeseries database. This is overwritten
# by the test suite once ClickHouse starts, with the actual address on which it
# is listening.
[timeseries_db]
address = "[::1]:0"

# Tunable parameters used during tests
[tunables]
# Allow small subnets, so we can test IP address exhaustion easily / quickly
max_vpc_ipv4_subnet_prefix = 29

[deployment]
# Identifier for this instance of Nexus.
# NOTE: The test suite always overrides this.
id = "913233fe-92a8-4635-9572-183f495429c4"
rack_id = "c19a698f-c6f9-4a17-ae30-20d711b8f7dc"
techport_external_server_port = 0

# Nexus may need to resolve external hosts (e.g. to grab IdP metadata).
# These are the DNS servers it should use.
external_dns_servers = ["1.1.1.1", "9.9.9.9"]

[deployment.dropshot_external]
# NOTE: for the test suite, the port MUST be 0 (in order to bind to any
# available port) because the test suite will be running many servers
# concurrently.
bind_address = "127.0.0.1:0"
default_request_body_max_bytes = 1048576

[deployment.dropshot_internal]
bind_address = "127.0.0.1:0"
default_request_body_max_bytes = 1048576

[deployment.dropshot_lockstep]
bind_address = "127.0.0.1:0"
default_request_body_max_bytes = 1048576

#
# NOTE: for the test suite, the internal DNS address will be replaced with one
# that's started by the test runner.
#
[deployment.internal_dns]
type = "from_subnet"
subnet.net = "fd00:1122:3344:0100::/56"

#
# NOTE: for the test suite, the database URL will be replaced with one
# appropriate for the database that's started by the test runner.
#
[deployment.database]
type = "from_url"
url = "postgresql://root@127.0.0.1:0/omicron?sslmode=disable"

# Dendrite (dataplane daemon) API configuration
[dendrite.switch0]
address = "[::1]:12224"

[background_tasks]
dns_internal.period_secs_config = 60
dns_internal.period_secs_servers = 60
dns_internal.period_secs_propagation = 60
dns_internal.max_concurrent_server_updates = 5
dns_external.period_secs_config = 60
dns_external.period_secs_servers = 60
dns_external.period_secs_propagation = 60
dns_external.max_concurrent_server_updates = 5
metrics_producer_gc.period_secs = 60
# How frequently we check the list of stored TLS certificates.  This is
# approximately an upper bound on how soon after updating the list of
# certificates it will take _other_ Nexus instances to notice and stop serving
# them (on a sunny day).
external_endpoints.period_secs = 60
nat_cleanup.period_secs = 30
bfd_manager.period_secs = 30
# How frequently to check for a new inventory collection (made by any Nexus).
# This is cheap, so we should check frequently.
inventory.period_secs_load = 15
# How frequently to collect hardware/software inventory from the whole system
# (even if we don't have reason to believe anything has changed).
inventory.period_secs_collect = 600
# Maximum number of past collections to keep in the database
inventory.nkeep = 3
# Disable inventory collection altogether (for emergencies)
inventory.disable_collect = false
phantom_disks.period_secs = 30
physical_disk_adoption.period_secs = 30
# Disable automatic disk adoption to avoid interfering with tests.
physical_disk_adoption.disable = true
# Set this to a value that's so high as to not fire during tests unless
# explicitly requested.
support_bundle_collector.period_secs = 999999
decommissioned_disk_cleaner.period_secs = 60
# Disable disk decommissioning cleanup to avoid interfering with tests.
decommissioned_disk_cleaner.disable = true
blueprints.period_secs_load = 100
blueprints.period_secs_plan = 600
blueprints.period_secs_execute = 600
blueprints.period_secs_rendezvous = 600
blueprints.period_secs_collect_crdb_node_ids = 600
blueprints.period_secs_load_reconfigurator_config = 5
sync_service_zone_nat.period_secs = 30
switch_port_settings_manager.period_secs = 30
# Set this (and other region / region snapshot replacement machinery) to a
# value that's so high as to not fire during tests unless explicitly requested.
region_replacement.period_secs = 999999
# The driver task should wake up frequently, something like every 10 seconds.
# however, if it's this low it affects the test_omdb_success_cases test output.
# keep this high enough so that the test shows "triggered by an explicit
# signal" instead of "triggered by a periodic timer firing"
region_replacement_driver.period_secs = 999999
instance_watcher.period_secs = 30
service_firewall_propagation.period_secs = 300
v2p_mapping_propagation.period_secs = 30
abandoned_vmm_reaper.period_secs = 60
saga_recovery.period_secs = 600
lookup_region_port.period_secs = 60
# The purpose of the `instance-updater` background task is to ensure that update
# sagas are always *eventually* started for instances whose database state has
# changed, even if the update saga was not started by the Nexus replica handling
# an update from sled-agent. This is to ensure that updates are performed even
# in cases where a Nexus crashes or otherwise disappears between when the
# updated VMM and migration state is written to CRDB and when the resulting
# update saga actually starts executing. However, we would prefer update sagas
# to be executed in a timely manner, so for integration tests, we don't want to
# *rely* on the instance-updater background task for running these sagas.
#
# Therefore, disable the background task during tests.
instance_updater.disable = true
instance_updater.period_secs = 60
# How frequently to attempt to restart Failed instances?
#
# The default activation period for this task is once every sixty seconds.
# However, the task's unit tests rely on explicit activations of the task
# finding all instances eligible for reincarnation. Thus, we don't want the
# periodic activation to occur whilst running those tests, since it may
# reincarnate instances that we expect an explicit activation to reincarnate,
# removing them from the set of instances eligible for reincarnation. Thus, set
# the period much longer than the default for test purposes.
instance_reincarnation.period_secs = 600
region_snapshot_replacement_start.period_secs = 999999
region_snapshot_replacement_garbage_collection.period_secs = 999999
region_snapshot_replacement_step.period_secs = 999999
region_snapshot_replacement_finish.period_secs = 999999
# The default activation period for this task is 60s, but we want to activate it
# manually to test the result of each activation, so set the activation period
# to something we'll never see in a test run.
tuf_artifact_replication.period_secs = 3600
# Update integration tests are started with 4 sled agents.
tuf_artifact_replication.min_sled_replication = 3
tuf_repo_pruner.period_secs = 300
# How many extra recent target releases to keep
# The system always keeps two: the current release and the previous one.
# This number is in addition to that.
tuf_repo_pruner.nkeep_extra_target_releases = 1
# How many extra recently uploaded repos to keep
# The system always keeps one, assuming that the operator may be about to
# update to it.  This number is in addition to that.
tuf_repo_pruner.nkeep_extra_newly_uploaded = 1
# In general, the webhook dispatcher will be activated when events are queued,
# so we don't need to periodically activate it *that* frequently.
alert_dispatcher.period_secs = 60
webhook_deliverator.period_secs = 60
# In order to test webhook delivery retry behavior without waiting for a long
# time, turn these backoff periods down from multiple minutes to just a couple
# seconds.
webhook_deliverator.first_retry_backoff_secs = 10
webhook_deliverator.second_retry_backoff_secs = 20
read_only_region_replacement_start.period_secs = 999999
sp_ereport_ingester.period_secs = 30
probe_distributor.period_secs = 60

[default_region_allocation_strategy]
# we only have one sled in the test environment, so we need to use the
# `Random` strategy, instead of `RandomWithDistinctSleds`
type = "random"

[omdb]
# In production omdb is shipped alongside Nexus in its zone; this doesn't happen
# (and isn't needed) in tests.
bin_path = "/cannot/fetch/omdb/in/test/suite"
