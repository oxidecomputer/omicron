[workspace]
members = [
    "common",
    "ddm-admin-client",
    "deploy",
    "gateway",
    "gateway/faux-mgs",
    "gateway-cli",
    "gateway-client",
    "gateway-messages",
    "gateway-sp-comms",
    "internal-dns",
    "internal-dns-client",
    "nexus",
    "nexus/authz-macros",
    "nexus/db-macros",
    "nexus/db-model",
    "nexus/defaults",
    "nexus/test-utils",
    "nexus/test-utils-macros",
    "nexus/types",
    "nexus-client",
    "package",
    "rpaths",
    "sled-agent",
    "sled-agent-client",
    "sp-sim",
    "oxide-client",
    "oximeter/oximeter",
    "oximeter/collector",
    "oximeter/db",
    "oximeter/instruments",
    "oximeter/producer",
    "oximeter/oximeter-macro-impl",
    "oximeter-client",
    "test-utils",
]

default-members = [
    "common",
    "ddm-admin-client",
    "deploy",
    "gateway",
    "gateway/faux-mgs",
    "gateway-cli",
    "gateway-client",
    "gateway-messages",
    "gateway-sp-comms",
    "internal-dns",
    "internal-dns-client",
    "nexus",
    "nexus/authz-macros",
    "nexus/db-macros",
    "nexus/db-model",
    "nexus/defaults",
    "nexus/types",
    "package",
    "rpaths",
    "sled-agent",
    "sled-agent-client",
    "sp-sim",
    "oxide-client",
    "oximeter/oximeter",
    "oximeter/collector",
    "oximeter/db",
    "oximeter/instruments",
    "oximeter/producer",
    "oximeter/oximeter-macro-impl",
    "oximeter-client",
    "test-utils",
]
resolver = "2"

[profile.dev]
panic = "abort"

# `bindgen` is used by `samael`'s build script; building it with optimizations
# makes that build script run ~5x faster, more than offsetting the additional
# build time added to `bindgen` itself.
[profile.dev.package.bindgen]
opt-level = 3

# `lalrpop` is used by `polar-core`'s build script; building it with
# optimizations makes that build script run ~20x faster, more than offsetting
# the additional build time added to `lalrpop` itself.
[profile.dev.package.lalrpop]
opt-level = 3

[profile.release]
panic = "abort"

# The following patch is needed to temporarily to resolve a cyclic dependency +
# breaking change.
#
# Steno recently had a breaking change (steno#29).  omicron-common uses steno.
# Almost all of the targets in this repo use the copy of omicron_common that is
# itself in this repo.  That one has been updated to use a newer steno.
# However, omicron-sled-agent (also in this repo) pulls in crucible, which pulls
# in omicron-common _not_ from this repo (since it can't -- it's in another
# repo) but rather from "main".  As a result, if we try to build everything in
# this repo, we'll wind up with two copies of omicron-common.  One of them will
# be updated to use the new steno.  The other one will not.  But both depend on
# steno branch "main".
#
# The workaround here is that when we build crucible, we override its
# omicron-common dependency to point to the local path one, which has been
# updated for the new Steno.
#
# Once we land this onto "main", we can immediately remove this workaround
# because any subsequent build will pick up the updated omicron-common.
[patch."https://github.com/oxidecomputer/omicron"]
omicron-common = { path = "./common" }

#
# It's common during development to use a local copy of dropshot, propolis
# or steno in the parent directory.  If you want to use those, uncomment
# one of these blocks.
#
#[patch."https://github.com/oxidecomputer/dropshot"]
#dropshot = { path = "../dropshot/dropshot" }
#[patch."https://github.com/oxidecomputer/steno"]
#steno = { path = "../steno" }
#[patch."https://github.com/oxidecomputer/propolis"]
#propolis-client = { path = "../propolis/client" }
#propolis-server = { path = "../propolis/server" }
#[patch."https://github.com/oxidecomputer/crucible"]
#crucible = { path = "../crucible/upstairs" }

#
# Local client generation during development.
#
#[patch."https://github.com/oxidecomputer/progenitor"]
#progenitor = { path = "../progenitor/progenitor" }
#[patch."https://github.com/oxidecomputer/typify"]
#typify = { path = "../typify/typify" }

#
# We maintain a fork of pq-sys to address upstream issues.  See the
# README.oxide.md in the "oxide" branch of our fork for details.
#
[patch.crates-io.pq-sys]
git = 'https://github.com/oxidecomputer/pq-sys'
branch = "oxide/omicron"
