// This Source Code Form is subject to the terms of the Mozilla Public
// License, v. 2.0. If a copy of the MPL was not distributed with this
// file, You can obtain one at https://mozilla.org/MPL/2.0/.

use std::fmt;

use iddqd::{IdOrdItem, IdOrdMap, id_upcast};
use omicron_uuid_kinds::MupdateUuid;
use schemars::JsonSchema;
use serde::{Deserialize, Serialize};
use tufaceous_artifact::ArtifactHash;

/// Describes a set of files written out into an install dataset.
/// This is currently used for zones and reference measurements
#[derive(Clone, Debug, Eq, PartialEq, Deserialize, Serialize, JsonSchema)]
pub struct OmicronInstallManifest {
    /// The source of the manifest.
    pub source: OmicronInstallManifestSource,

    /// Omicron install file names and hashes.
    pub files: IdOrdMap<OmicronInstallMetadata>,
}

impl OmicronInstallManifest {
    /// The name of the zones file.
    pub const ZONES_FILE_NAME: &str = "zones.json";

    /// The name of the measurment file
    pub const MEASUREMENT_FILE_NAME: &str = "measurements.json";
}

/// The source of truth for an Omicron zone manifest.
#[derive(
    Clone, Copy, Debug, Eq, PartialEq, Deserialize, Serialize, JsonSchema,
)]
#[serde(tag = "source", rename_all = "snake_case")]
pub enum OmicronInstallManifestSource {
    /// The manifest was written out by installinator and the mupdate process.
    Installinator {
        /// The UUID of the mupdate.
        mupdate_id: MupdateUuid,
    },

    /// The zone manifest was not found during the install process. A synthetic
    /// zone manifest was generated by Sled Agent by looking at all the
    /// `.tar.gz` files in the install dataset.
    SledAgent,
}

impl fmt::Display for OmicronInstallManifestSource {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        match self {
            OmicronInstallManifestSource::Installinator { mupdate_id } => {
                write!(f, "installinator (mupdate ID: {})", mupdate_id)
            }
            OmicronInstallManifestSource::SledAgent => {
                write!(f, "sled-agent")
            }
        }
    }
}

/// Information about an Omicron zone file written out to the install dataset.
///
/// Part of [`OmicronInstallManifest`].
#[derive(
    Clone,
    Debug,
    Eq,
    Ord,
    PartialEq,
    PartialOrd,
    Deserialize,
    Serialize,
    JsonSchema,
)]
pub struct OmicronInstallMetadata {
    /// The file name.
    pub file_name: String,

    /// The file size.
    pub file_size: u64,

    /// The hash of the file.
    pub hash: ArtifactHash,
}

impl IdOrdItem for OmicronInstallMetadata {
    type Key<'a> = &'a str;

    #[inline]
    fn key(&self) -> Self::Key<'_> {
        &self.file_name
    }

    id_upcast!();
}
