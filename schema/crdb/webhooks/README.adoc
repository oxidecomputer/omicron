# Overview

This migration adds initial tables required for webhook delivery.

## Upgrade steps

The individual transactions in this upgrade do the following:

* *Webhook receivers*:
** `up01.sql` creates the `omicron.public.webhook_receiver` table, which stores
the receiver endpoints that receive webhook events.
** `up02.sql` creates the `lookup_webhook_rx_by_id` index on that table, for listing non-deleted webhook receivers.
** `up03.sql` creates the `lookup_webhook_rx_by_name` index on that table, for looking up receivers by name (and ensuring names are unique across all non-deleted receivers).
** *Secrets*:
*** `up04.sql` creates the `omicron.public.webhook_secret` table, which
associates webhook receivers with secret keys and their IDs.
*** `up05.sql` creates the `lookup_webhook_secrets_by_rx` index on that table,
for looking up all secrets associated with a receiver.
* *Event classes, subscriptions, and globbing*:
** `up06.sql` creates the `omicron.public.webhook_event_class` enum type
** *Globs*:
*** `up07.sql` creates the `omicron.public.webhook_rx_event_glob` table, which contains any subscriptions created by a receiver that have glob patterns. This table is used when generating exact subscription from globs.
*** `up08.sql` creates the `lookup_webhook_event_globs_for_rx` index on `webhook_rx_event_glob`, for looking up all globs belonging to a receiver by ID.
*** `up09.sql` creates the `lookup_webhook_event_globs_by_schema_version` index on `webhook_rx_event_glob`, for searching for globs with outdated schema versions.
** *Subscriptions*:
*** `up10.sql` creates the `omicron.public.webhook_rx_subscription` table, which tracks the event classes that a receiver is subscribed to. If a row in this table represents a subscription that was generated by a glob, this table also references the glob record.
*** `up11.sql` creates the `lookup_webhook_rxs_for_event_class` index on `webhook_rx_subscription`, for listing all the receivers subscribed to an event class
*** `up12.sql` creates the `lookup_exact_subscriptions_for_webhook_rx` index, for looking up the exact subscriptions (not globs) for a receiver by ID. This is used along with `lookup_webhook_event_globs_for_rx` index when listing the user-provided event class strings.
* *Webhook events*:
** `up13.sql` creates the `omicron.public.webhook_event` table, which contains the
values of actual webhook events. The dispatcher operates on entries in
this queue, dispatching the event to receivers and generating the payload for
each receiver.
** `up14.sql` inserts the singleton row in `webhook_event` used for liveness probes. This singleton exists so that delivery records for liveness probes can have event UUIDs that point at a real entry in `webhook_event`, without requiring a new event entry to be created for each probe.
** `up15.sql` creates the `lookup_undispatched_webhook_events` index on `webhook_event` for looking up webhook messages which have not yet been dispatched, and ordering by their creation times.
* *Webhook message dispatching and delivery attempts*:
** *Dispatch table*:
*** `up16.sql` creates the `omicron.public.webhook_delivery_trigger` enum, which tracks why a webhook delivery was initiated.

*** `up17.sql` creates the `omicron.public.webhook_delivery_state` enum, representing the current state of a webhook delivery.
*** `up18.sql` creates the table `omicron.public.webhook_delivery`, which tracks the webhook messages that have been dispatched to receivers.
*** `up19.sql` creates the `one_webhook_event_dispatch_per_rx` unique index on `webhook_delivery`.
+
This index functions as a `UNIQUE` constraint on the tuple of `(event_id, rx_id)`, but ONLY for rows with `trigger = 'event'`. This ensures that concurrently-executing webhook dispatchers will not create multiple deliveries when dispatching a new event, but permits multiple re-deliveries of an event to be explicitly triggered.
*** `up20.sql` creates an index `lookup_webhook_delivery_dispatched_to_rx` for looking up
entries in `webhook_delivery` by receiver ID.
*** `up21.sql` creates an index `lookup_webhook_deliveries_for_event` on `webhook_delivery` for looking up deliveries by event UUID.
*** `up22.sql` creates an index `webhook_deliveries_in_flight` for looking up all currently in-flight webhook
deliveries (entries where the `time_completed` field has not been set).
** *Delivery attempts*:
*** `up23.sql` creates the enum `omicron.public.webhook_delivery_attempt_result`,
representing the potential outcomes of a webhook delivery attempt.
*** `up24.sql` creates the table `omicron.public.webhook_delivery_attempt`,
which records each individual delivery attempt for a webhook delivery in the
`webhook_delivery` table.
*** `up25.sql` creates an index `lookup_attempts_for_webhook_delivery` on
`webhook_delivery_attempt`, for looking up the attempts for a given delivery ID.
*** `up26.sql` creates an index `lookup_webhook_delivery_attempts_to_rx` on the `webhook_delivery_attempt` table, for looking up delivery attempts to a given receiver ID. This is primarily used for deleting delivery attempts when a receiver is deleted.
