# Overview

This migration adds initial tables required for webhook delivery.

## Upgrade steps

The individual transactions in this upgrade do the following:

* *Webhook receivers*:
** `up01.sql` creates the `omicron.public.webhook_rx` table, which stores
the receiver endpoints that receive webhook events.
** *Receiver secrets*:
*** `up02.sql` creates the `omicron.public.webhook_secret` table, which
associates webhook receivers with secret keys and their IDs.
*** `up03.sql` creates the `lookup_webhook_secrets_by_rx` index on that table,
for looking up all secrets associated with a receiver.
** *Receiver subscriptions*:
*** `up04.sql` creates the `omicron.public.webhook_rx_subscription` table, which
associates a webhook receiver with multiple event classes that the receiver is
subscribed to.
*** `up05.sql` creates an index `lookup_webhook_subscriptions_by_rx` for
looking up all event classes that a receiver ID is subscribed to.
*** `up06.sql` creates an index `lookup_webhook_rxs_for_event` on
`omicron.public.webhook_rx_subscription` for looking up all receivers subscribed
to a particular event class.
* *Webhook message queue*:
** `up07.sql` creates the `omicron.public.webhook_event` table, which contains the
queue of un-dispatched webhook events. The dispatcher operates on entries in
this queue, dispatching the event to receivers and generating the payload for
each receiver.
** `up08.sql` creates the `lookup_undispatched_webhook_events` index on
`omicron.public.webhook_event` for looking up webhook messages which have not yet been
dispatched and ordering by their creation times.
* *Webhook message dispatching and delivery attempts*:
** *Dispatch table*:
*** `up09.sql` creates the table `omicron.public.webhook_delivery`, which
tracks the webhook messages that have been dispatched to receivers.
*** `up10.sql` creates an index `lookup_webhook_dispatched_to_rx` for looking up
entries in `omicron.public.webhook_delivery` by receiver ID.
*** `up11.sql` creates an index `webhook_delivery_in_flight` for looking up all currently in-flight webhook
messages (entries in `omicron.public.webhook_delivery` where the
`time_completed` field has not been set).
** *Delivery attempts*:
*** `up12.sql` creates the enum `omicron.public.webhook_delivery_result`,
representing the potential outcomes of a webhook delivery attempt.
*** `up13.sql` creates the table `omicron.public.webhook_delivery_attempt`,
which records each individual delivery attempt for a webhook message in the
`webhook_delivery` table.
*** `up14.sql` creates an index `lookup_webhook_delivery_attempt_for_msg` on
`omicron.public.webhook_delivery_attempt`, for looking up all attempts to
deliver a message with a given dispatch ID.
