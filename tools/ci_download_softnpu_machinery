#!/bin/bash
#
# This script fetches the following from CI
#
#   - the softnpu ASIC simulator (softnpu)
#   - a softnpu admin program (scadm)
#   - the sidecar-lite precompiled P4 program
#


# This is the softnpu ASIC emulator
if [[ ! -f out/softnpu/softnpu ]]; then
    echo "fetching softnpu"
    # This comes from a separate repo from the below artifacts,
    SOFTNPU_COMMIT="88f5f1334364e5580fe778c44ac0746a35927351"
    COMMIT_URL="https://buildomat.eng.oxide.computer/public/file/oxidecomputer/softnpu/image/$SOFTNPU_COMMIT"
    curl -OL "$COMMIT_URL/softnpu"
    chmod +x softnpu
    mkdir -p out/softnpu
    mv softnpu out/softnpu/
fi

# Commit and base URL that's pinned for softnpu tools
SIDECAR_LITE_COMMIT="b74895bce931202209a1b958be6ec3062d51742b"
COMMIT_URL="https://buildomat.eng.oxide.computer/public/file/oxidecomputer/sidecar-lite/release/$SIDECAR_LITE_COMMIT"

# This is an ASIC administration program.
if [[ ! -f out/softnpu/scadm ]]; then
    echo "fetching scadm"
    curl -OL "$COMMIT_URL/scadm"
    chmod +x scadm
    mv scadm out/softnpu/
fi

# Fetch the pre-compiled sidecar_lite p4 program
if [[ ! -f out/softnpu/libsidecar_lite.so ]]; then
    echo "fetching libsidecar_lite.so"
    curl -OL "$COMMIT_URL/libsidecar_lite.so"
    mv libsidecar_lite.so out/softnpu/
fi
