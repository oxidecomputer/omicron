= Boundary Services A-Z

This document describes how to run an environment with boundary services.
It's a quick rundown and assumes knowledge of the basic setup described in the
Running Omicron (Non-Simulated) document.

== 0. Download SoftNPU ASIC emulator machinery

Grab the SoftNPU (ASIC simulator, scadm, P4 program, etc.) from CI:

----
./tools/ci_download_softnpu_machinery
----

(By default `install_runner_prerequisites.sh` will take care of running
`ci_download_softnpu_machinery` for you.)

== 1. Setup virtual hardware

----
PHYSICAL_LINK=<wan interface> pfexec ./tools/create_virtual_hardware.sh
----
Note that the `PHYSICAL_LINK` environment variable is optional. If not supplied,
the first link in `dladm show-phys` will be used.

The virtual hardware is a bit different than what has previously been used. What
we now have looks like this.

image::plumbing.png[]

The `softnpu` zone will be configured and launched during the `create_virtual_hardware.sh`
script.

== 2. Build and install the control plane.

----
./tools/create_self_signed_cert.sh

cargo build --release --bin omicron-package
./target/release/omicron-package -t <target_name> target create -i standard -m non-gimlet -s softnpu
./target/release/omicron-package package
pfexec ./target/release/omicron-package install
----

The control plane is now starting, reference the Running Omicron (Non-Simulated)
doc for more details on determining when things are ready to go.

Once the control plane is running, `softnpu` can be configured via `dendrite`
using `swadm`. An example script is provided in `tools/scrimlet/softnpu-init.sh`.
This script should work without modification for basic development setups,
but feel free to tweak it as needed.

----
$ ./tools/scrimlet/softnpu-init.sh
++ netstat -rn -f inet
++ grep default
++ awk -F ' ' '{print $2}'
+ GATEWAY_IP=10.85.0.1
+ echo 'Using 10.85.0.1 as gateway ip'
Using 10.85.0.1 as gateway ip
++ arp 10.85.0.1
++ awk -F ' ' '{print $4}'
+ GATEWAY_MAC=68:d7:9a:1f:77:a1
+ echo 'Using 68:d7:9a:1f:77:a1 as gateway mac'
Using 68:d7:9a:1f:77:a1 as gateway mac
+ ./out/softnpu/swadm -h '[fd00:1122:3344:101::2]' port add 1:0 100G RS
+ ./out/softnpu/swadm -h '[fd00:1122:3344:101::2]' port add 2:0 100G RS
+ ./out/softnpu/swadm -h '[fd00:1122:3344:101::2]' addr add 1:0 fe80::aae1:deff:fe01:701c
+ ./out/softnpu/swadm -h '[fd00:1122:3344:101::2]' addr add 2:0 fe80::aae1:deff:fe01:701d
+ ./out/softnpu/swadm -h '[fd00:1122:3344:101::2]' addr add 1:0 fd00:99::1
+ ./out/softnpu/swadm -h '[fd00:1122:3344:101::2]' route add fd00:1122:3344:0101::/64 1:0 fe80::aae1:deff:fe00:1
+ ./out/softnpu/swadm -h '[fd00:1122:3344:101::2]' arp add fe80::aae1:deff:fe00:1 a8:e1:de:00:00:01
+ ./out/softnpu/swadm -h '[fd00:1122:3344:101::2]' route add 0.0.0.0/0 2:0 10.85.0.1
+ ./out/softnpu/swadm -h '[fd00:1122:3344:101::2]' arp add 10.85.0.1 68:d7:9a:1f:77:a1
+ ./out/softnpu/swadm -h '[fd00:1122:3344:101::2]' port list
 NAME  MEDIA    SPEED   FEC     ENA   LINK  MAC
  1:0  Copper   100G    RS      Ena   Up    a8:40:25:71:e3:82
  2:0  Copper   100G    RS      Ena   Up    a8:40:25:71:e3:83
+ ./out/softnpu/swadm -h '[fd00:1122:3344:101::2]' addr list
Port  IPv4  IPv6
1:0         fd00:99::1
            fe80::aae1:deff:fe01:701c
2:0         fe80::aae1:deff:fe01:701d
+ ./out/softnpu/swadm -h '[fd00:1122:3344:101::2]' route list
Subnet                                      Port     Gateway
0.0.0.0/0                                   2:0      10.85.0.1
fd00:1122:3344:101::/64                     1:0      fe80::aae1:deff:fe00:1
+ ./out/softnpu/swadm -h '[fd00:1122:3344:101::2]' arp list
host                            mac                age
10.85.0.1                       68:d7:9a:1f:77:a1  0s
fe80::aae1:deff:fe00:1          a8:e1:de:00:00:01  0s
----

== 4. Populating the system

Follow the
https://github.com/oxidecomputer/omicron/blob/main/docs/how-to-run.adoc[how-to-run.adoc]
to set up IPs, images, disks, instances etc. Things to pay particular attention
to here are the following.

- The address range in the IP pool should be on a subnet in your local network that
  can NAT out to the Internet.
- Be sure to set up an external IP for the instance you create.

You will need to set up `proxy-arp` if your VM external IP addresses are on the
same L2 network as the router or other non-oxide hosts:
----
pfexec /opt/oxide/softnpu/stuff/scadm \
  --server /opt/oxide/softnpu/stuff/server \
  --client /opt/oxide/softnpu/stuff/client \
  standalone \
  add-proxy-arp \
  $ip_pool_start \
  $ip_pool_end \
  $softnpu_mac
----

== 5. Configuring scrimlet/sidecar

A this point we have an instance up and running with external connectivity
configured via boundary services:
----
ry@korgano:~/omicron$ ~/propolis/target/release/propolis-cli --server fd00:1122:3344:101::c serial

debian login: root
Linux debian 5.10.0-9-amd64 #1 SMP Debian 5.10.70-1 (2021-09-30) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
root@debian:~# host oxide.computer
oxide.computer has address 76.76.21.61
oxide.computer has address 76.76.21.22
oxide.computer mail is handled by 5 alt2.aspmx.l.google.com.
oxide.computer mail is handled by 1 aspmx.l.google.com.
oxide.computer mail is handled by 10 aspmx3.googlemail.com.
oxide.computer mail is handled by 5 alt1.aspmx.l.google.com.
oxide.computer mail is handled by 10 aspmx2.googlemail.com.
----
